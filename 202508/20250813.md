# 배포와 운용전략

## Blue-Green 배포
- Blue-Green 배포는 MLOps 환경에서 Kubernetes를 사용하여 모델을 배포할 때 새로운 버전의 모델을 배포하는 무중단 배포 전략 중 하나입니다.
- 여기서 보통 blue는 현재 서비스중인 모델/파이프라인을 의미하고, green은 새로 배포할 모델이나 파이프라인을 의미합니다.
- Blue-green 무중단 배포는 다음과 같은 단계로 이루어집니다

![alt text](https://docs.aws.amazon.com/images/sagemaker/latest/dg/images/deployment-guardrails-blue-green-all-at-once.png)

*출저: AWS: [Blue/Green Deployment](https://docs.aws.amazon.com/sagemaker/latest/dg/deployment-guardrails-blue-green-all-at-once.html)*

1.	Blue는 프로덕션 트래픽 처리
2.	Green에 새 모델 배포
3.	실제 데이터로 검증(섀도우 테스트 등)
4.	검증 완료 후 트래픽 전환
5.	문제 시 즉시 Blue로 롤백

## Blue Green 배포의 장점
- Blue와 green을 동시에 배포하고 진행하여, 문제가 생기면 바로 blue로 전환하여 안정적으로 롤백이 가능합니다.
- 트래픽을 한번에 100% 전환하여, 큰 문제가 생기지 않는다면, 다른 배포 방식에 비해 비교적 짧은 시간 내에 무중단 배포를 완료할 수 있습니다.

## Blue Green 배포의 단점
- 두 개의 환경을 유지해야 하기 때문에 리소스, 비용이 크게 증가할 수 있습니다.


## Blue Green 배포 코드 간단 예제

1. 머신러닝 모델 코드 (python)
- 아래 파이썬 코드는 MODEL_VERSION 환경변수로 모델을 구분하여 서로 다른 모델 (blue/green)을 배포하는 FastAPI 코드입니다.
  
```python
# app.py
from fastapi import FastAPI
from pydantic import BaseModel
import os


MODEL_VERSION = os.getenv("MODEL_VERSION", "blue")

class DummyModel:
    def predict(self, X): return [sum(x) for x in X]
model = DummyModel()


class PredictRequest(BaseModel):
    features: list[list[float]]


app = FastAPI(title="Model API", version=MODEL_VERSION)

@app.post("/predict")
def predict(req: PredictRequest):
    preds = model.predict(req.features)
    return {"version": MODEL_VERSION, "predictions": preds}
```

1. 서로 다른 모델 배포
- 각 컨테이너마다 환경변수를 다르게 하여 두 버전의 FastAPI 코드를 배포합니다
- 배포하기 전, 먼저 Dockerfile을 작성합니다.

```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt
COPY app.py ./
# optionally COPY model.pkl ./
ENV MODEL_VERSION=blue
ENV MODEL_PATH=/app/model.pkl
EXPOSE 8000
CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8000"]
```
- 작성된 Dockerfile로 먼저 blue 모델을 배포합니다
```bash
docker build -t {docker-hub-username}/model-api:blue .
docker push {docker-hub-username}/model-api:blue
```

- 비슷한 방법으로 green model도 같이 배포합니다. 이때 환경변수를 추가하여 fastapi코드에서 green 모델을 사용하도록 합니다.
```bash
docker build -t {docker-hub-username}/model-api:green --build-arg MODEL_VERSION=green .
docker push {docker-hub-username}//model-api:green
```